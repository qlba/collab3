## Лекция 2

### Принципы функционирования центрального процессора

**Машинная команда** - это описание операции, которую должна выполнить ЭВМ, закодированное в двоичном виде. Содержит выполняемые операции и коды операндов (адреса ячеек оперативной памяти). Команды бывают следующих видов: 

1. Арифметические (сложение, вычитание, умножение, деление - ADD, SUB, MUL, DIV)
2. Логические (и, или, исключающее или, отрицание - AND, OR, XOR, NOT)
3. Команды ввода-вывода (ввод, вывод с помощью портов - IN, OUT)
4. Команды перехода и вызова подпрограмм (JMP, CALL,LOOP, JLE, JOP, и т. д.)
5. Команды для работы с прерываниями

Совокупность операций, выполняемых процессором, называется *система команд*.  Мы будем изучать систему команд x86.

**Регистры** - это ячейки быстродействующей памяти, расположенные непосредственно на кристалле процессора. 

картинка 1

Аналогичную структуру имеют регистры **RBX, RCX, RDX**. В 64-битной архитектуре добавлены восемь новых регистров: **R0-R7**. 

### Работа с регистрами

Очищать регистры можно с помощью XOR. XOR EAX, EAX даст 0 в EAX. Эта команда занимает меньше места и выполняется быстрее, чем MOV EAX, 0. Чтобы заполнить регистр единицами, можно записать в него 0FFFFFFFFh - самое большое возможное число.

Пара примеров:

```asm
MOV EAX, 0FFFFFFFFh

ADD EAX, 1 ; EAX = 000000000h, т.к. произошел перенос

ADD AX, 1 ; EAX = 0FFFF0000h, т.к. произошел перенос (но мы работали с 16-ричным разрядом).
```

При возникновении переноса устанавливается флаг переноса CF.

Надо помнить, что 16-ричной системе счисления 1 байт = 2 цифры. $FF_{16}=255_{10}$. Тетрада - набор из четырех бит, обозначается одной шестнадцатеричной цифрой.

Любая команда процессора работает только с той частью регистра, которая указана в ее описании. 

Программисту доступны регистры общего назначения EAX, EBX, ECX, EDX, индексные ESI, EDI и регистр EBP. Индексные регистры чаще используют для работы с массивами, в них записывают адреса ячеек оперативной памяти. EBP обычно используется компиляторами для адресации аргументов функций и локальных переменных, но программист может их использовать по собственному усмотрению. ESP - указатель на вершину стека. 

#### Назначение стека

1. В стеке хранятся локальные переменные
2. При вызове подпрограмм в стек сохраняется адрес возврата из подпрограммы.
3. В стек обычно передаются аргументы подпрограммы.

Размер стека небольшой, порядка нескольких мегабайт.

**EIP** указывает на текущую выполняемую инструкцию, увеличивается на размер выполненной команды.

**EFLAGS** - 32-битный регистр, который содержит несколько флагов - переноса, переполнения, четности, направления, трассировки и другие. 
**Флаг** - однобитный регистр, в котором сохраняется информация о выполнении последней команды. То есть, флаги отражают текущее состояние процессора. 

**Сегментные регистры** - шестнадцатиразрядные регистры.

- CS (code segment) содержит номер сегмента кода, с которым работает программа.
- DS (data segment) - номер сегмента данных
- SS (stack segment) - номер сегмента стека
- ES
- FS

В операционной системе Windows используется сплошная модель памяти, поэтому данные, код и стек располагаются в одном адресном пространстве.

#### Директивы для определения переменных:

Типы данных:

- DB - 1 байт, char
- DW - 2 слово, short
- DD - 4 двойное слово, int
- DF - 6 тройное слово long double
- DQ - 8 учетверенное слово, long long
- DT - 10 упятеренное слово

Вещественные числа могут храниться как четырехбайтовые и восьмибайтовые. Некоторые команды процессора требуют указания размера аргумента. (Аналог приведения типа). Для этого используются  директивы приведения типа:

- byte ptr - 1 байт
- word ptr - слово
- dword ptr - 4 байта
- qword ptr - 8 байт